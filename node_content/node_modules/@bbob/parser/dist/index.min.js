!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).BbobParser={})}(this,function(t){"use strict";let e=t=>"object"==typeof t&&!!t.tag,r=t=>"string"==typeof t,n=(t,e,r)=>Object.keys(t).reduce(e,r),s=t=>e(t)?t.content.reduce((t,e)=>t+s(e),0):r(t)?t.length:0,i=(t,e)=>{t.content.push(e)},l=t=>t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;").replace(/(javascript|data|vbscript):/gi,"$1%3A"),a=(t,e)=>{let r=typeof e,n={boolean:()=>e?""+t:"",number:()=>`${t}="${e}"`,string:()=>`${t}="${l(e)}"`,object:()=>`${t}="${l(JSON.stringify(e))}"`};return n[r]?n[r]():""},o=t=>null==t?"":n(t,(e,r)=>[...e,a(r,t[r])],[""]).join(" "),u=t=>n(t,(e,r)=>t[r]===r?t[r]:null,null),g=(t,e)=>{let r=u(e);if(r){let n=a(t,r),s={...e};delete s[r];let i=o(s);return`${n}${i}`}return`${t}${o(e)}`};class h{attr(t,e){return void 0!==e&&(this.attrs[t]=e),this.attrs[t]}append(t){return i(this,t)}get length(){return s(this)}toTagStart({openTag:t="[",closeTag:e="]"}={}){let r=g(this.tag,this.attrs);return`${t}${r}${e}`}toTagEnd({openTag:t="[",closeTag:e="]"}={}){return`${t}/${this.tag}${e}`}toTagNode(){return new h(this.tag.toLowerCase(),this.attrs,this.content)}toString({openTag:t="[",closeTag:e="]"}={}){let r=0===this.content.length,n=this.content.reduce((r,n)=>r+n.toString({openTag:t,closeTag:e}),""),s=this.toTagStart({openTag:t,closeTag:e});return r?s:`${s}${n}${this.toTagEnd({openTag:t,closeTag:e})}`}constructor(t,e,r){this.tag=t,this.attrs=e,this.content=Array.isArray(r)?r:[r]}}h.create=(t,e={},r=[])=>new h(t,e,r),h.isOf=(t,e)=>t.tag===e;let c="type",f="value",p="line",d=t=>t&&void 0!==t[f]?t[f]:"",b=t=>t&&t[p]||0,T=t=>t&&t.row||0,y=t=>!!t&&void 0!==t[c]&&(5===t[c]||6===t[c]||1===t[c]),N=t=>!!t&&void 0!==t[c]&&2===t[c],x=t=>47===d(t).charCodeAt(0),A=t=>!x(t),$=t=>!!t&&void 0!==t[c]&&3===t[c],k=t=>!!t&&void 0!==t[c]&&4===t[c],m=t=>{let e=d(t);return x(t)?e.slice(1):e},L=t=>d(t)+"]";class C{isEmpty(){return isNaN(this[c])}isText(){return y(this)}isTag(){return N(this)}isAttrName(){return $(this)}isAttrValue(){return k(this)}isStart(){return A(this)}isEnd(){return x(this)}getName(){return m(this)}getValue(){return d(this)}getLine(){return b(this)}getColumn(){return T(this)}toString(){return L(this)}constructor(t,e,r,n){this[c]=Number(t),this[f]=String(e),this[p]=Number(r),this.row=Number(n)}}function w(t,e){let r={pos:0,len:t.length},n=e=>{let{pos:n}=r,s=t.indexOf(e,n);return s>=0?t.substring(n,s):""},s=e=>t.indexOf(e,r.pos)>=0,i=()=>r.len>r.pos,l=(t=1,n)=>{r.pos+=t,e&&e.onSkip&&!n&&e.onSkip()},a=()=>t.substring(r.pos),o=(e=0)=>t.substring(r.pos,r.pos+e),u=()=>t[r.pos],g=()=>{let e=r.pos-1;return void 0!==t[e]?t[e]:null},h=()=>{let e=r.pos+1;return e<=t.length-1?t[e]:null},c=(e,n)=>{let s=0;if(i())for(s=r.pos;i()&&e(u());)l(1,n);return t.substring(s,r.pos)};this.skip=l,this.hasNext=i,this.getCurr=u,this.getRest=a,this.getNext=h,this.getPrev=g,this.isLast=()=>r.pos===r.len,this.includes=s,this.grabWhile=c,this.grabN=o,this.substrUntilChar=n}let S=(t,e)=>new w(t,e),v=(t,e)=>{for(;t.charAt(0)===e;)t=t.substring(1);for(;t.charAt(t.length-1)===e;)t=t.substring(0,t.length-1);return t},O=t=>t.replace('\\"','"');function E(t=[]){let e=()=>Array.isArray(t)&&t.length>0&&void 0!==t[t.length-1]?t[t.length-1]:null,r=()=>!!t.length&&t.pop(),n=e=>t.push(e);this.push=n,this.toArray=()=>t,this.getLast=e,this.flushLast=r}let W=(t=[])=>new E(t),V=(t,e,r=0,n=0)=>new C(t,e,r,n);function j(t,e={}){let r=0,n=0,s=-1,i=0,l=0,a="",o=Array(Math.floor(t.length)),u=e.openTag||"[",g=e.closeTag||"]",h=!!e.enableEscapeTags,c=e.contextFreeTags||[],f=e.onToken||(()=>{}),p=[g,u,'"',"\\"," ","	","=","\n","!"],d=[u," ","	","\n"],b=[" ","	"],T=["="," ","	"],y=t=>p.indexOf(t)>=0,N=t=>"\n"===t,x=t=>b.indexOf(t)>=0,A=t=>-1===d.indexOf(t),$=t=>T.indexOf(t)>=0,k=t=>t===u||t===g||"\\"===t,m=t=>"\\"===t,L=()=>{n++},C=t=>O(v(t,'"')),w=(t,e)=>{""!==a&&e&&(a=""),""===a&&c.includes(t)&&(a=t)},E=S(t,{onSkip:L});function W(t,e){let i=V(t,e,r,n);f(i),o[s+=1]=i}return{tokenize:function(){for(i=0;E.hasNext();)switch(i){case 1:i=function(){let t=E.getCurr(),e=E.getNext();E.skip();let r=E.substrUntilChar(g),n=0===r.length||r.indexOf(u)>=0;if(y(e)||n||E.isLast())return W(1,t),0;let s=-1===r.indexOf("="),i="/"===r[0];if(s||i){let l=E.grabWhile(t=>t!==g);return E.skip(),W(2,l),w(l,i),0}return 2}();break;case 2:i=function(){let t=E.grabWhile(t=>t!==g,!0),e=S(t,{onSkip:L}),r=e.includes(" ");for(l=0;e.hasNext();)l=function(t,e){if(1===l){let r=t=>!("="===t||x(t)),n=t.grabWhile(r),s=t.isLast(),i="="!==t.getCurr();return(t.skip(),s||i?W(4,C(n)):W(3,n),s)?0:i?1:2}if(2===l){let a=!1,o=r=>{let n=t.getPrev(),s=t.getNext(),i=x(r),l=x(s);return!!(a&&$(r))||('"'!==r||"\\"===n||!!(a=!a)||"="===s||!!l)&&(!!e||!1===i)},u=t.grabWhile(o);return(t.skip(),W(4,C(u)),t.isLast())?0:1}let g=e=>!("="===e||x(e)||t.isLast()),h=t.grabWhile(g);if(W(2,h),w(h),t.skip(),e)return 2;let c=t.includes("=");return c?1:2}(e,!r);return E.skip(),0}();break;default:i=function(){if(N(E.getCurr()))return W(6,E.getCurr()),E.skip(),n=0,r++,0;if(x(E.getCurr())){let t=E.grabWhile(x);return W(5,t),0}if(E.getCurr()===u){if(a){let e=u.length+1+a.length,s=`${u}/${a}`,i=E.grabN(e);if(i===s)return 1}else if(E.includes(g))return 1;return W(1,E.getCurr()),E.skip(),0}if(h){if(m(E.getCurr())){let l=E.getCurr(),o=E.getNext();return(E.skip(),k(o))?(E.skip(),W(1,o),0):(W(1,l),0)}let c=t=>A(t)&&!m(t),f=E.grabWhile(c);return W(1,f),0}let p=E.grabWhile(A);return W(1,p),0}()}return o.length=s+1,o},isTokenNested:function(e){let r=u+"/"+e.getValue();return t.indexOf(r)>-1}}}let z=(t,r={})=>{let n=r.openTag||"[",s=r.closeTag||"]",i=null,l=W(),a=W(),o=W(),u=W(),g=new Set,c=t=>{let e=t.getValue();return!g.has(e)&&i.isTokenNested&&i.isTokenNested(t)?(g.add(e),!0):g.has(e)},f=t=>Boolean(g.has(t)),p=t=>!r.onlyAllowTags||!r.onlyAllowTags.length||r.onlyAllowTags.indexOf(t)>=0,d=()=>{o.flushLast()&&u.flushLast()},b=()=>{let t=a.getLast();return t&&Array.isArray(t.content)?t.content:l.toArray()},T=t=>{let r=b();Array.isArray(r)&&(e(t)?p(t.tag)?r.push(t.toTagNode()):(r.push(t.toTagStart({openTag:n,closeTag:s})),t.content.length&&(t.content.forEach(t=>{r.push(t)}),r.push(t.toTagEnd({openTag:n,closeTag:s})))):r.push(t))},y=t=>{d();let e=h.create(t.getValue()),r=c(t);o.push(e),r?a.push(e):T(e)},N=t=>{d();let e=a.flushLast();if(e)T(e);else if("function"==typeof r.onError){let n=t.getValue(),s=t.getLine(),i=t.getColumn();r.onError({message:`Inconsistent tag '${n}' on line ${s} and column ${i}`,tagName:n,lineNumber:s,columnNumber:i})}},x=t=>{t.isStart()&&y(t),t.isEnd()&&N(t)},A=t=>{let e=o.getLast(),r=t.getValue(),n=f(t);if(e){if(t.isAttrName())u.push(r),e.attr(u.getLast(),"");else if(t.isAttrValue()){let s=u.getLast();s?(e.attr(s,r),u.flushLast()):e.attr(r,r)}else t.isText()?n?e.append(r):T(r):t.isTag()&&T(t.toString())}else t.isText()?T(r):t.isTag()&&T(t.toString())},$=t=>{t.isTag()?x(t):A(t)};return(i=(r.createTokenizer?r.createTokenizer:j)(t,{onToken:$,openTag:n,closeTag:s,onlyAllowTags:r.onlyAllowTags,contextFreeTags:r.contextFreeTags,enableEscapeTags:r.enableEscapeTags})).tokenize(),l.toArray()};t.TagNode=h,t.default=z,t.parse=z,Object.defineProperty(t,"__esModule",{value:!0})});
